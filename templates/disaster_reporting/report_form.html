{% extends 'dashboard/base.html' %}

{% block page_title %}Submit Disaster Report{% endblock %}
{% block page_subtitle %}Help your community by reporting emergencies and issues in real-time{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50/20 py-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header Section -->
        <div class="mb-8">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                <div>
                    <div class="flex items-center space-x-3 mb-2">
                        <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-orange-500 rounded-xl flex items-center justify-center shadow-lg">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 15.5c-.77.833.192 2.5 1.732 2.5z"/>
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Emergency Reporting</h1>
                            <p class="text-gray-600 text-base sm:text-lg max-w-2xl">Select a location on the map to report an emergency or community issue</p>
                        </div>
                    </div>
                </div>
                <div class="mt-4 lg:mt-0 flex items-center space-x-2">
                    <span class="inline-flex items-center text-sm text-gray-600 bg-white px-3 py-2 rounded-lg border border-gray-200 shadow-sm">
                        <svg class="w-4 h-4 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                        </svg>
                        <span class="font-medium">Secure & Verified</span>
                    </span>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 xl:grid-cols-12 gap-8">
            <!-- Left Sidebar - Recent Reports & Contacts -->
            <div class="xl:col-span-3 space-y-6">
                <!-- Recent Reports -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="p-4 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
                        <h3 class="font-semibold text-gray-900 flex items-center">
                            <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            Recent Reports
                        </h3>
                    </div>
                    <div class="p-4 max-h-80 overflow-y-auto">
                        <div id="recent-reports" class="space-y-3">
                            <!-- Reports will be populated here -->
                        </div>
                        <div id="recent-reports-empty" class="text-center py-8">
                            <svg class="w-12 h-12 text-gray-300 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <p class="text-gray-500 text-sm">No recent reports found</p>
                        </div>
                    </div>
                </div>

                <!-- Emergency Contacts -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="p-4 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
                        <h3 class="font-semibold text-gray-900 flex items-center">
                            <svg class="w-5 h-5 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                            </svg>
                            Emergency Contacts
                        </h3>
                    </div>
                    <div class="p-4 space-y-3">
                        <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors">
                            <span class="text-gray-700 flex items-center">
                                <svg class="w-5 h-5 text-blue-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                                </svg>
                                <span>Police</span>
                            </span>
                            <a href="tel:911" class="text-red-600 font-medium hover:text-red-700">911</a>
                        </div>
                        <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors">
                            <span class="text-gray-700 flex items-center">
                                <svg class="w-5 h-5 text-red-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z"/>
                                </svg>
                                <span>Fire Department</span>
                            </span>
                            <a href="tel:911" class="text-red-600 font-medium hover:text-red-700">911</a>
                        </div>
                        <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors">
                            <span class="text-gray-700 flex items-center">
                                <svg class="w-5 h-5 text-green-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                                </svg>
                                <span>Ambulance</span>
                            </span>
                            <a href="tel:911" class="text-red-600 font-medium hover:text-red-700">911</a>
                        </div>
                        <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors">
                            <span class="text-gray-700 flex items-center">
                                <svg class="w-5 h-5 text-purple-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"/>
                                </svg>
                                <span>Coast Guard</span>
                            </span>
                            <a href="tel:911" class="text-red-600 font-medium hover:text-red-700">911</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content - Map Area -->
            <div class="xl:col-span-9 relative z-0">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden h-[600px] relative z-0">
                    <!-- Map Controls Header -->
                    <div class="absolute top-4 left-4 right-4 z-10">
                        <div class="flex items-center justify-between">
                            <div class="bg-white/90 backdrop-blur-sm rounded-xl p-3 shadow-lg border border-gray-200">
                                <h3 class="font-semibold text-gray-900 flex items-center text-sm">
                                    <svg class="w-5 h-5 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    </svg>
                                    Click on map to select incident location
                                </h3>
                            </div>
                        </div>
                    </div>

                    <!-- Map Container -->
                    <div id="map" class="w-full h-full relative z-0"></div>

                    <!-- Map Legend -->
                    <div class="absolute bottom-4 left-4 z-10">
                        <div class="bg-white/90 backdrop-blur-sm rounded-xl p-4 shadow-lg border border-gray-200">
                            <div class="flex items-center space-x-4 text-sm text-gray-600">
                                <div class="flex items-center space-x-1">
                                    <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                                    <span>Your Location</span>
                                </div>
                                <div class="flex items-center space-x-1">
                                    <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                    <span>Selected Location</span>
                                </div>
                                <div class="flex items-center space-x-1">
                                    <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                                    <span>Other Reports</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Location Instructions -->
                    <div id="location-instructions" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-20 text-center bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-2xl border border-gray-200 max-w-sm">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Select a Location</h3>
                        <p class="text-gray-600 text-sm">Click anywhere on the map to mark the incident location and start your report</p>
                    </div>
                </div>

                <!-- Report Button - Fixed at bottom-right of main component -->
                <button 
                    id="report-button"
                    class="report-btn hidden fixed bottom-6 right-24 sm:right-28 md:right-32 bg-gradient-to-r from-red-500 to-orange-500 text-white px-6 py-4 rounded-xl shadow-2xl hover:from-red-600 hover:to-orange-600 transition-all duration-300 transform-gpu hover:scale-105 font-semibold flex items-center space-x-3 z-30 border-2 border-white"
                >
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span class="text-lg">Report Incident</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Slide-out Report Form -->
<div id="report-form-overlay" class="fixed inset-0 bg-black/50 z-[5000] hidden transition-opacity duration-300"></div>
<div id="report-form-sidebar" class="fixed top-0 right-0 h-full w-full max-w-md bg-white shadow-2xl z-[6000] transform translate-x-full transition-transform duration-300 ease-in-out overflow-y-auto transform-gpu">
    <div class="flex flex-col h-full">
        <!-- Form Header -->
        <div class="p-6 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                        <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                        </svg>
                        Report Incident
                    </h2>
                    <p class="text-sm text-gray-600 mt-1">Provide details about the emergency</p>
                </div>
                <button id="close-form" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Form Content -->
        <form id="report-form" class="flex-1 p-6 space-y-6">
            <!-- Selected Location Display -->
            <div class="bg-blue-50 rounded-xl p-4 border border-blue-200">
                <label class="block text-sm font-semibold text-gray-900 mb-2 flex items-center">
                    <svg class="w-4 h-4 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    Selected Location
                </label>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-gray-600 mb-1 block">Latitude</label>
                        <input type="text" id="latitude" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-sm font-mono" readonly>
                    </div>
                    <div>
                        <label class="text-xs text-gray-600 mb-1 block">Longitude</label>
                        <input type="text" id="longitude" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-sm font-mono" readonly>
                    </div>
                </div>
                <div class="mt-3 flex items-center gap-4">
                    <button type="button" id="change-location" class="text-blue-600 hover:text-blue-700 text-sm font-medium flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Change Location
                    </button>
                    <button type="button" id="use-current-location" class="text-blue-600 hover:text-blue-700 text-sm font-medium flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M4.93 4.93l14.14 14.14M12 2a10 10 0 100 20 10 10 0 000-20z"/>
                        </svg>
                        Use Current Location
                    </button>
                    <span id="geo-loading" class="inline-flex items-center text-xs text-gray-500 hidden">
                        <svg class="w-3 h-3 mr-1 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Locating...
                    </span>
                </div>
            </div>

            <!-- Category -->
            <div>
                <label class="block text-sm font-semibold text-gray-900 mb-3 flex items-center">
                    <svg class="w-4 h-4 text-purple-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                    </svg>
                    Incident Type
                </label>
                <div class="relative">
                    <select id="category" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all duration-200 bg-white appearance-none" required>
                        <option value="fire">Fire Emergency</option>
                        <option value="flood">Flood Situation</option>
                        <option value="earthquake">Earthquake</option>
                        <option value="medical">Medical Emergency</option>
                        <option value="road_damage">Road Damage/Accident</option>
                        <option value="building_collapse">Building Collapse</option>
                        <option value="power_outage">Power Outage</option>
                        <option value="pothole">Pothole</option>
                        <option value="theft">Theft/Robbery</option>
                        <option value="other">Other Emergency</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Severity -->
            <div>
                <label class="block text-sm font-semibold text-gray-900 mb-3 flex items-center">
                    <svg class="w-4 h-4 text-orange-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 15.5c-.77.833.192 2.5 1.732 2.5z"/>
                    </svg>
                    Severity Level
                </label>
                <div class="grid grid-cols-3 gap-2">
                    <button type="button" class="severity-btn p-3 border border-gray-300 rounded-lg text-center hover:border-green-300 hover:bg-green-50 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500" data-level="low" aria-pressed="false">
                        <div class="w-3 h-3 bg-green-500 rounded-full mx-auto mb-2"></div>
                        <span class="text-xs font-medium text-gray-700">Low</span>
                    </button>
                    <button type="button" class="severity-btn p-3 border border-gray-300 rounded-lg text-center hover:border-yellow-300 hover:bg-yellow-50 transition-colors focus:outline-none focus:ring-2 focus:ring-yellow-500" data-level="medium" aria-pressed="true">
                        <div class="w-3 h-3 bg-yellow-500 rounded-full mx-auto mb-2"></div>
                        <span class="text-xs font-medium text-gray-700">Medium</span>
                    </button>
                    <button type="button" class="severity-btn p-3 border border-gray-300 rounded-lg text-center hover:border-red-300 hover:bg-red-50 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500" data-level="high" aria-pressed="false">
                        <div class="w-3 h-3 bg-red-500 rounded-full mx-auto mb-2"></div>
                        <span class="text-xs font-medium text-gray-700">High</span>
                    </button>
                </div>
                <input type="hidden" id="severity" value="medium">
            </div>

            <!-- Description -->
            <div>
                <label class="block text-sm font-semibold text-gray-900 mb-3 flex items-center">
                    <svg class="w-4 h-4 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                    Incident Description
                </label>
                <textarea id="description" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all duration-200 resize-none bg-white" rows="4" maxlength="500" placeholder="Provide detailed information about the incident, including any immediate dangers, number of people affected, and current situation..." required></textarea>
                <div class="flex justify-between text-xs text-gray-500 mt-2">
                    <span>Be specific and include relevant details</span>
                    <span id="char-count">0/500</span>
                </div>
            </div>

            <!-- Image Upload -->
            <div>
                <label class="block text-sm font-semibold text-gray-900 mb-3 flex items-center">
                    <svg class="w-4 h-4 text-pink-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    Upload Evidence
                </label>
                <div id="drop-area" class="drop-area border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-gray-400 transition-colors cursor-pointer bg-gray-50">
                    <svg class="w-8 h-8 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    <p class="text-sm text-gray-600 mb-2">Drag & drop images here</p>
                    <p class="text-xs text-gray-500 mb-4">Supports JPG, PNG, GIF, MP4 â€¢ Max 5MB (images) / 25MB (video)</p>
                    <button type="button" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium">
                        Choose Files
                    </button>
                </div>
                <input type="file" id="image" hidden accept="image/*,video/*" multiple>
                <div id="image-preview" class="mt-3 grid grid-cols-3 gap-2 hidden"></div>
            </div>

            <!-- Identity Preference -->
            <div class="bg-gray-50 rounded-xl p-4 flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                    </svg>
                    <span class="text-sm text-gray-700">Submit anonymously</span>
                </div>
                <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="is_anonymous" class="rounded">
                </label>
            </div>

            <!-- Submit Button -->
            <button 
                type="submit" 
                id="submit-btn"
                class="w-full py-4 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl hover:from-green-700 hover:to-green-800 transition-all duration-300 transform hover:-translate-y-0.5 shadow-lg hover:shadow-xl font-semibold flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-green-500"
            >
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                </svg>
                Submit Emergency Report
            </button>

            <!-- Privacy Notice -->
            <div class="text-center">
                <p class="text-xs text-gray-500">
                    <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                    </svg>
                    Your report will be shared with emergency services and community responders
                </p>
            </div>
        </form>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading" class="fixed inset-0 bg-black/50 flex items-center justify-center z-[7000] hidden" role="status" aria-live="assertive">
    <div class="bg-white rounded-2xl p-6 text-center max-w-sm mx-4 shadow-2xl">
        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-blue-600 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Submitting Report</h3>
        <p class="text-gray-600 text-sm">Please wait while we process your emergency report...</p>
    </div>
</div>

<!-- Success Modal -->
<div id="success-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-[7000] hidden" role="dialog" aria-modal="true" aria-labelledby="success-title">
    <div class="bg-white rounded-2xl p-6 text-center max-w-sm mx-4 shadow-2xl">
        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
        </div>
        <h3 id="success-title" class="text-lg font-semibold text-gray-900 mb-2">Report Submitted</h3>
        <p class="text-gray-600 text-sm mb-4">Your emergency report has been successfully submitted. Authorities have been notified.</p>
        <button id="success-ok" class="w-full py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500">
            Continue
        </button>
    </div>
</div>

<style>
    .drop-area.drag-over {
        border-color: #3b82f6;
        background-color: #eff6ff;
    }
    
    .severity-btn.active {
        border-color: #f59e0b;
        background-color: #fffbeb;
    }
    
    .severity-btn[data-level="low"].active {
        border-color: #10b981;
        background-color: #ecfdf5;
    }
    
    .severity-btn[data-level="medium"].active {
        border-color: #f59e0b;
        background-color: #fffbeb;
    }
    
    .severity-btn[data-level="high"].active {
        border-color: #ef4444;
        background-color: #fef2f2;
    }
    
    .image-preview-item {
        position: relative;
    }
    
    .image-preview-item img {
        border-radius: 8px;
    }
    
    .remove-image {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 24px;
        height: 24px;
        background: #ef4444;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .remove-image:hover {
        background: #dc2626;
        transform: scale(1.1);
    }
    
    /* Animation classes */
    .report-btn.shake {
        animation: shake 0.5s ease-in-out;
    }
    
    .report-btn.pulse {
        animation: pulse 2s infinite;
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    /* Custom map styles */
    .leaflet-popup-content-wrapper {
        border-radius: 12px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    
    .leaflet-popup-tip {
        box-shadow: none;
    }
</style>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    // Map initialization and interaction
    var map = L.map('map', {
        zoomControl: false
    }).setView([0, 0], 13);
    
    // Add zoom controls
    L.control.zoom({
        position: 'topright'
    }).addTo(map);
    
    // Add custom tile layer with better styling
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        maxZoom: 19
    }).addTo(map);
    
    // Marker icons
    var userIcon = L.divIcon({
        html: '<div class="w-8 h-8 bg-blue-600 rounded-full border-2 border-white shadow-lg flex items-center justify-center" aria-label="Your location"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg></div>',
        iconSize: [32, 32],
        iconAnchor: [16, 16],
        className: 'user-location-marker'
    });

    var incidentIcon = L.divIcon({
        html: '<div class="w-10 h-10 bg-red-600 rounded-full border-2 border-white shadow-lg flex items-center justify-center" aria-label="Incident location"><svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/></svg></div>',
        iconSize: [40, 40],
        iconAnchor: [20, 20],
        className: 'incident-location-marker'
    });

    // Variables
    var userMarker;
    var selectedMarker;
    var selectedLat = null;
    var selectedLng = null;

    // Geolocation and auto-populate
    navigator.geolocation.getCurrentPosition(function(position) {
        var lat = position.coords.latitude;
        var lon = position.coords.longitude;
        map.setView([lat, lon], 13);
        userMarker = L.marker([lat, lon], { icon: userIcon })
            .addTo(map)
            .bindPopup("<div class='text-center'><b>Your Current Location</b><br>You are here</div>")
            .openPopup();
        loadExistingReports();
    }, function(error) {
        console.log("Geolocation error:", error);
        map.setView([40.7128, -74.0060], 10);
        loadExistingReports();
    });

    function loadExistingReports() {
        fetch('/disaster-reporting/api/reports/')
            .then(r => r.json())
            .then(data => {
                renderRecentReports(data || []);
                (data || []).forEach(function(report) {
                    var icon = L.divIcon({
                        html: '<div class="w-8 h-8 bg-yellow-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 15.5c-.77.833.192 2.5 1.732 2.5z"/></svg></div>',
                        iconSize: [32, 32], iconAnchor: [16, 16], className: 'other-incident-marker'
                    });
                    if (report.latitude && report.longitude) {
                        L.marker([report.latitude, report.longitude], { icon })
                            .addTo(map)
                            .bindPopup("<div class='text-center'><b>Reported Incident</b><br>" + (report.description || '') + "</div>");
                    }
                });
            })
            .catch(() => {
                // Handle error silently
            });
    }

    // Click to Select Location
    map.on('click', function(event) {
        var lat = event.latlng.lat;
        var lon = event.latlng.lng;

        setSelectedLocation(lat, lon);
        
        // Show and animate the report button
        const reportBtn = document.getElementById('report-button');
        reportBtn.classList.remove('hidden');
        reportBtn.classList.add('shake', 'pulse');
        
        // Hide instructions
        document.getElementById('location-instructions').classList.add('hidden');
        
        // Remove animations after they complete
        setTimeout(() => {
            reportBtn.classList.remove('shake');
        }, 500);
    });

    function setSelectedLocation(lat, lon) {
        selectedLat = lat;
        selectedLng = lon;
        
        if (selectedMarker) map.removeLayer(selectedMarker);
        selectedMarker = L.marker([lat, lon], { icon: incidentIcon })
            .addTo(map)
            .bindPopup("<div class='text-center'><b>Selected Incident Location</b><br>Click 'Report Incident' to continue</div>")
            .openPopup();
        
        // Update form fields if form is open
        document.getElementById("latitude").value = lat.toFixed(6);
        document.getElementById("longitude").value = lon.toFixed(6);
    }

    // Report Button Click - Open Form
    document.getElementById('report-button').addEventListener('click', function() {
        openReportForm();
    });

    // Close Form Button
    document.getElementById('close-form').addEventListener('click', function() {
        closeReportForm();
    });

    // Overlay Click - Close Form
    document.getElementById('report-form-overlay').addEventListener('click', function() {
        closeReportForm();
    });

    // Change Location Button
    document.getElementById('change-location').addEventListener('click', function() {
        closeReportForm();
        // Show instructions again
        document.getElementById('location-instructions').classList.remove('hidden');
    });

    document.getElementById('use-current-location').addEventListener('click', function() {
        var loader = document.getElementById('geo-loading');
        loader.classList.remove('hidden');
        
        // Check if geolocation is supported
        if (!navigator.geolocation) {
            loader.classList.add('hidden');
            alert('Geolocation is not supported by your browser.');
            return;
        }
        
        // Check if running on HTTPS (required for geolocation in modern browsers)
        if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
            loader.classList.add('hidden');
            alert('Geolocation requires HTTPS connection. Please use a secure connection or select location on the map.');
            return;
        }
        
        // Enhanced geolocation options for better accuracy
        var geoOptions = {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 60000
        };
        
        navigator.geolocation.getCurrentPosition(function(pos) {
            loader.classList.add('hidden');
            var lat = pos.coords.latitude;
            var lon = pos.coords.longitude;
            setSelectedLocation(lat, lon);
            map.setView([lat, lon], 15);
            openReportForm();
        }, function(err) {
            loader.classList.add('hidden');
            
            // Enhanced error handling with specific messages
            var errorMessage = 'Unable to retrieve your location. ';
            switch(err.code) {
                case err.PERMISSION_DENIED:
                    errorMessage += 'Location access was denied. Please enable location permissions in your browser settings.';
                    break;
                case err.POSITION_UNAVAILABLE:
                    errorMessage += 'Location information is unavailable. Please check your device location settings.';
                    break;
                case err.TIMEOUT:
                    errorMessage += 'Location request timed out. Please try again or select location on the map.';
                    break;
                default:
                    errorMessage += 'An unknown error occurred. Please select location on the map.';
                    break;
            }
            
            // Add debug information
            console.log('Geolocation error details:', {
                code: err.code,
                message: err.message,
                protocol: window.location.protocol,
                hostname: window.location.hostname
            });
            
            alert(errorMessage);
        }, geoOptions);
    });

    function openReportForm() {
        document.getElementById('report-form-overlay').classList.remove('hidden');
        document.getElementById('report-form-sidebar').classList.remove('translate-x-full');
        // Stop pulsing animation when form opens
        document.getElementById('report-button').classList.remove('pulse');
    }

    function closeReportForm() {
        document.getElementById('report-form-sidebar').classList.add('translate-x-full');
        setTimeout(() => {
            document.getElementById('report-form-overlay').classList.add('hidden');
            // Clear text inputs and selects manually to preserve file input
            const form = document.getElementById('report-form');
            form.querySelectorAll('input[type="text"], textarea, select').forEach(input => {
                if (input.type !== 'checkbox') {
                    input.value = '';
                } else {
                    input.checked = false;
                }
            });
            
            // Clear image previews
            document.getElementById('image-preview').innerHTML = '';
            document.getElementById('image-preview').classList.add('hidden');
            
            // Reset drop area to original state but preserve the file input
            const dropArea = document.getElementById('drop-area');
            const fileInput = document.getElementById('image');
            dropArea.innerHTML = `
                <svg class="w-8 h-8 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                </svg>
                <p class="text-sm text-gray-600 mb-2">Drag & drop images or videos here</p>
                <p class="text-xs text-gray-500 mb-4">Supports JPG, PNG, GIF (max 5MB) and MP4 (max 25MB)</p>
                <button type="button" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium">
                    Choose Files
                </button>
            `;
            // Re-attach event listeners
            dropArea.addEventListener("click", () => fileInput.click());
        }, 300);
    }

    // Severity Selection
    document.querySelectorAll('.severity-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.severity-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            document.getElementById('severity').value = this.dataset.level;
            document.querySelectorAll('.severity-btn').forEach(b => b.setAttribute('aria-pressed', 'false'));
            this.setAttribute('aria-pressed', 'true');
        });
    });

    // Initialize medium severity as active
    document.querySelector('.severity-btn[data-level="medium"]').classList.add('active');

    // Character Count
    document.getElementById('description').addEventListener('input', function() {
        var len = this.value.length;
        document.getElementById('char-count').textContent = len + '/500';
    });

    // Image Upload Handling (same as before)
    const dropArea = document.getElementById("drop-area");
    const imageInput = document.getElementById("image");
    const imagePreview = document.getElementById("image-preview");
    
    // File management system
    let selectedFiles = []; // Array to manage selected files
    let fileProcessingController = null; // For cancellation
    const MAX_FILE_SIZE = 25 * 1024 * 1024; // 25MB
    const ALLOWED_TYPES = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'video/mp4'];
    const MAX_FILES = 10; // Maximum number of files

    dropArea.addEventListener("click", () => imageInput.click());
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
        dropArea.classList.add('drag-over');
    }

    function unhighlight() {
        dropArea.classList.remove('drag-over');
    }

    dropArea.addEventListener('drop', handleDrop, false);
    imageInput.addEventListener('change', handleFiles, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles({ target: { files } });
    }

    function validateFile(file) {
        if (!ALLOWED_TYPES.includes(file.type)) {
            return { valid: false, error: `File type ${file.type} not supported. Please use JPG, PNG, GIF, or MP4.` };
        }
        if (file.size > MAX_FILE_SIZE) {
            return { valid: false, error: `File ${file.name} is too large. Maximum size is 25MB.` };
        }
        return { valid: true };
    }

    function clearSelectedFiles() {
        selectedFiles = [];
        imagePreview.innerHTML = '';
        imagePreview.classList.add('hidden');
        imageInput.value = ''; // Clear the actual file input
        updateDropAreaDefault();
    }

    function updateDropAreaDefault() {
        dropArea.innerHTML = `
            <svg class="w-12 h-12 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9.9.9 0 01-1 1.9h-7.9z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            <p class="text-gray-600 mb-2">Drag & drop images/videos here</p>
            <p class="text-xs text-gray-500 mb-4">or click to browse</p>
            <button type="button" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium">
                Choose Files
            </button>
        `;
    }

    function updateDropAreaWithFiles() {
        const totalSize = selectedFiles.reduce((sum, file) => sum + file.size, 0);
        const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(1);
        
        dropArea.innerHTML = `
            <div class="flex items-center justify-between w-full">
                <div class="flex items-center">
                    <svg class="w-8 h-8 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    <div>
                        <p class="text-sm font-medium text-gray-900">${selectedFiles.length} file(s) selected</p>
                        <p class="text-xs text-gray-500">${totalSizeMB} MB total</p>
                    </div>
                </div>
                <button type="button" id="clear-files-btn" class="text-red-600 hover:text-red-800 text-sm font-medium">
                    Clear All
                </button>
            </div>
        `;
        
        // Add event listener for clear button
        document.getElementById('clear-files-btn').addEventListener('click', clearSelectedFiles);
    }

    function handleFiles(e) {
        const newFiles = Array.from(e.target.files);
        console.log('New files selected:', newFiles.length);
        console.log('File details:', newFiles.map(f => ({name: f.name, type: f.type, size: f.size})));
        
        // Validate new files
        const validFiles = [];
        const errors = [];
        
        newFiles.forEach(file => {
            const validation = validateFile(file);
            if (validation.valid) {
                validFiles.push(file);
            } else {
                errors.push(validation.error);
            }
        });
        
        // Check total file limit
        if (selectedFiles.length + validFiles.length > MAX_FILES) {
            errors.push(`Maximum ${MAX_FILES} files allowed. You have ${selectedFiles.length} already selected.`);
            validFiles.splice(MAX_FILES - selectedFiles.length);
        }
        
        // Show errors if any
        if (errors.length > 0) {
            alert('File validation errors:\n' + errors.join('\n'));
        }
        
        // Add valid files to selected files
        if (validFiles.length > 0) {
            selectedFiles = [...selectedFiles, ...validFiles];
            updateDropAreaWithFiles();
            renderFilePreviews();
        }
        
        // Reset file input value to allow re-selecting the same files
        imageInput.value = '';
    }

    function renderFilePreviews() {
        imagePreview.innerHTML = '';
        if (selectedFiles.length === 0) {
            imagePreview.classList.add('hidden');
            return;
        }
        
        imagePreview.classList.remove('hidden');
        
        selectedFiles.forEach((file, index) => {
            const div = document.createElement('div');
            div.className = 'image-preview-item relative';
            div.id = `preview-${index}`;
            
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    div.innerHTML = `<img src="${e.target.result}" class="w-full h-20 object-cover rounded" alt="${file.name}">`;
                };
                reader.readAsDataURL(file);
            } else if (file.type.startsWith('video/')) {
                div.innerHTML = `
                    <video class="w-full h-20 object-cover rounded" muted>
                        <source src="${URL.createObjectURL(file)}" type="${file.type}">
                    </video>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                    </div>
                `;
            }
            
            // Add remove button
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-image';
            removeBtn.innerHTML = '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
            removeBtn.onclick = () => removeFile(index);
            
            div.appendChild(removeBtn);
            imagePreview.appendChild(div);
        });
    }

    function removeFile(index) {
        selectedFiles.splice(index, 1);
        if (selectedFiles.length === 0) {
            clearSelectedFiles();
        } else {
            renderFilePreviews();
            updateDropAreaWithFiles();
        }
    }

    // Form Submission
    document.getElementById("report-form").addEventListener("submit", function(event) {
        event.preventDefault();

        if (!selectedLat || !selectedLng) {
            alert('Please select a location on the map first.');
            return;
        }

        var category = document.getElementById("category").value;
        var description = document.getElementById("description").value;
        var severity = document.getElementById("severity").value;
        var isAnonymous = document.getElementById('is_anonymous').checked;

        if (!description || description.length > 500) {
            alert('Please provide a valid description (max 500 characters).');
            return;
        }

        var formData = new FormData();
        formData.append("category", category);
        formData.append("description", description);
        formData.append("severity", severity);
        formData.append("latitude", selectedLat);
        formData.append("longitude", selectedLng);
        formData.append("is_anonymous", isAnonymous);
        
        // Process all files before submitting
        const processFiles = async () => {
            const filePromises = [];
            
            if (selectedFiles.length === 0) {
                return;
            }
            
            // Create cancellation controller
            fileProcessingController = new AbortController();
            
            for (let i = 0; i < selectedFiles.length; i++) {
                // Check for cancellation
                if (fileProcessingController.signal.aborted) {
                    console.log('File processing cancelled');
                    throw new Error('File processing cancelled by user');
                }
                
                const file = selectedFiles[i];
                if (file.type.startsWith('image/')) {
                    // Create a promise for image compression with cancellation support
                    const compressionPromise = compressImage(file, 0.7).then(blob => {
                        formData.append('media', blob, file.name);
                    }).catch(err => {
                        throw err;
                    });
                    
                    filePromises.push(compressionPromise);
                } else if (file.type.startsWith('video/')) {
                    // Add video files directly
                    formData.append('media', file);
                }
            }
            
            // Wait for all image compression to complete with timeout
            
            // Add timeout to prevent infinite loading
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error('File processing timeout')), 30000); // 30 second timeout
            });
            
            try {
                await Promise.race([Promise.all(filePromises), timeoutPromise]);

            } catch (error) {
                if (error.message === 'File processing cancelled by user') {
                    throw error;
                } else if (error.message === 'File processing timeout') {
                    throw new Error('File processing timed out. Please try with smaller files or fewer files.');
                } else {
                    throw error;
                }
            }
        };

        // Process files first, then submit form
        processFiles().then(() => {
            // Check if any files were actually added
            if (formData.getAll('media').length === 0) {
                alert('No files were successfully processed. Please try different files.');
                return;
            }
            
            // Show loading overlay with cancellation option
            showLoadingOverlay();

            fetch('/disaster-reporting/api/reports/', {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'X-CSRFToken': getCookie('csrftoken') },
                body: formData
            }).then(async (resp) => {
                hideLoadingOverlay();
                if (!resp.ok) {
                    const errorData = await resp.json().catch(() => ({error: 'Unknown error'}));
                    const errorMessage = errorData.error || errorData.detail || 'Submission failed. Please try again.';
                    alert(`Submission failed: ${errorMessage}`);
                    return;
                }
                const data = await resp.json();
                const tracking = data.tracking_code || data.id;
                document.querySelector('#success-modal h3').textContent = 'Report Submitted';
                document.querySelector('#success-modal p').textContent = `Your tracking code: ${tracking}. Authorities have been notified.`;
                document.getElementById("success-modal").classList.remove("hidden");
                
                // Reset form and close sidebar
                closeReportForm();
                document.getElementById('report-button').classList.add('hidden');
                document.getElementById('location-instructions').classList.remove('hidden');
                if (selectedMarker) {
                    map.removeLayer(selectedMarker);
                    selectedMarker = null;
                }
                selectedLat = null;
                selectedLng = null;
                
                // Reload recent reports
                loadExistingReports();
            }).catch((error) => {
                hideLoadingOverlay();
                console.error('Network error:', error);
                alert('Network error. Please check your connection and try again.');
            });
        }).catch((error) => {
            hideLoadingOverlay();
            console.error('File processing error:', error);
            if (error.message === 'File processing cancelled by user') {
                alert('File upload cancelled. You can continue with your report or add different files.');
            } else if (error.message === 'File processing timed out. Please try with smaller files or fewer files.') {
                alert(error.message);
            } else {
                alert('Error processing files. Please try with different files or fewer files.');
            }
        });
    });

    // Success modal handler
    document.getElementById("success-ok").addEventListener("click", function() {
        document.getElementById("success-modal").classList.add("hidden");
    });

    function compressImage(file, quality=0.7) {
        return new Promise((resolve) => {
            const img = new Image();
            const canvas = document.createElement('canvas');
            const reader = new FileReader();
            reader.onload = e => { img.src = e.target.result; };
            img.onload = () => {
                const MAX_W = 1280; const MAX_H = 1280;
                let { width, height } = img;
                if (width > MAX_W || height > MAX_H) {
                    const ratio = Math.min(MAX_W/width, MAX_H/height);
                    width = width * ratio; height = height * ratio;
                }
                canvas.width = width; canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                canvas.toBlob((blob) => resolve(blob), 'image/jpeg', quality);
            };
            reader.readAsDataURL(file);
        });
    }

    // Loading overlay functions with cancellation
    function showLoadingOverlay() {
        const loadingOverlay = document.getElementById("loading");
        
        // Update loading overlay with cancellation option
        loadingOverlay.innerHTML = `
            <div class="bg-white rounded-2xl p-6 text-center max-w-sm mx-4 shadow-2xl">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-blue-600 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Processing Files</h3>
                <p class="text-gray-600 text-sm mb-4">Please wait while we process your media files...</p>
                <button type="button" id="cancel-upload-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm font-medium">
                    Cancel Upload
                </button>
            </div>
        `;
        
        loadingOverlay.classList.remove("hidden");
        
        // Add cancellation event listener
        document.getElementById('cancel-upload-btn').addEventListener('click', cancelFileProcessing);
    }
    
    function hideLoadingOverlay() {
        document.getElementById("loading").classList.add("hidden");
        // Reset controller for next use
        if (fileProcessingController) {
            fileProcessingController = null;
        }
    }
    
    function cancelFileProcessing() {
        if (fileProcessingController) {
            fileProcessingController.abort();
    
        }
        hideLoadingOverlay();
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function renderRecentReports(data) {
        var container = document.getElementById('recent-reports');
        var empty = document.getElementById('recent-reports-empty');
        container.innerHTML = '';
        if (!data.length) { empty.classList.remove('hidden'); return; }
        empty.classList.add('hidden');
        data.slice(0, 5).forEach(function(r) {
            var sev = (r.severity || 'medium');
            var sevClasses = sev === 'high' ? 'bg-red-50 border-red-100' : (sev === 'low' ? 'bg-green-50 border-green-100' : 'bg-yellow-50 border-yellow-100');
            var sevBadgeClasses = sev === 'high' ? 'bg-red-100 text-red-800' : (sev === 'low' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800');
            var wrap = document.createElement('div');
            wrap.className = 'flex items-start space-x-3 p-3 rounded-lg border ' + sevClasses;
            wrap.innerHTML = '<div class="w-2 h-2 rounded-full mt-2 ' + (sev === 'high' ? 'bg-red-500' : (sev === 'low' ? 'bg-green-500' : 'bg-yellow-500')) + '"></div>' +
                '<div class="flex-1">' +
                '<h4 class="font-medium text-gray-900">' + (r.category_display || r.category || 'Report') + '</h4>' +
                '<p class="text-xs text-gray-600">Severity: ' + sev + '</p>' +
                '<div class="flex items-center mt-1"><span class="text-xs px-2 py-1 rounded-full ' + sevBadgeClasses + '">' + (r.status_display || r.status || 'pending') + '</span></div>' +
                '</div>';
            container.appendChild(wrap);
        });
    }
</script>
{% endblock %}
