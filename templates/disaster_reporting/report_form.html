{% extends 'dashboard/base.html' %}

{% block page_title %} Submit Disaster Report{% endblock %}
{% block page_subtitle %}Help your community by reporting emergencies and issues in real-time{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
      crossorigin=""/>
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-blue-50/30 py-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header Section -->
        <div class="mb-8">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Emergency Reporting</h1>
                    <p class="text-gray-600 text-lg max-w-2xl">Report emergencies, disasters, or community issues to help authorities respond quickly and keep everyone safe.</p>
                </div>
                <div class="mt-4 lg:mt-0 flex items-center space-x-4">
                    <div class="flex items-center space-x-2 text-sm text-gray-500 bg-white px-3 py-2 rounded-lg shadow-sm">
                        <i class="fas fa-shield-alt text-green-500"></i>
                        <span>Verified Reporting</span>
                    </div>
                    <div class="flex items-center space-x-2 text-sm text-gray-500 bg-white px-3 py-2 rounded-lg shadow-sm">
                        <i class="fas fa-clock text-blue-500"></i>
                        <span>Real-time Alerts</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
            <!-- Left Sidebar - Recent Reports -->
            <div class="xl:col-span-1 space-y-6">
                <!-- Recent Reports -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6">
                    <h3 class="font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-history text-blue-600 mr-2"></i>
                        Recent Reports
                    </h3>
                    <div class="space-y-4">
                        <div class="flex items-start space-x-3 p-3 bg-red-50 rounded-lg border border-red-100">
                            <div class="w-2 h-2 bg-red-500 rounded-full mt-2"></div>
                            <div class="flex-1">
                                <h4 class="font-medium text-gray-900">Building Fire</h4>
                                <p class="text-xs text-gray-600">2 hours ago ‚Ä¢ 1.2km away</p>
                                <div class="flex items-center mt-1">
                                    <span class="text-xs px-2 py-1 bg-red-100 text-red-800 rounded-full">High Priority</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-yellow-50 rounded-lg border border-yellow-100">
                            <div class="w-2 h-2 bg-yellow-500 rounded-full mt-2"></div>
                            <div class="flex-1">
                                <h4 class="font-medium text-gray-900">Road Accident</h4>
                                <p class="text-xs text-gray-600">4 hours ago ‚Ä¢ 0.8km away</p>
                                <div class="flex items-center mt-1">
                                    <span class="text-xs px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full">Medium Priority</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-green-50 rounded-lg border border-green-100">
                            <div class="w-2 h-2 bg-green-500 rounded-full mt-2"></div>
                            <div class="flex-1">
                                <h4 class="font-medium text-gray-900">Power Outage</h4>
                                <p class="text-xs text-gray-600">6 hours ago ‚Ä¢ 2.1km away</p>
                                <div class="flex items-center mt-1">
                                    <span class="text-xs px-2 py-1 bg-green-100 text-green-800 rounded-full">Resolved</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Emergency Contacts -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6">
                    <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-phone-alt text-red-500 mr-2"></i>
                        Emergency Contacts
                    </h4>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors">
                            <span class="text-gray-700 flex items-center">
                                <i class="fas fa-shield-alt text-blue-500 mr-3"></i>
                                Police
                            </span>
                            <a href="tel:911" class="text-red-600 font-medium hover:text-red-700">911</a>
                        </div>
                        <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors">
                            <span class="text-gray-700 flex items-center">
                                <i class="fas fa-fire text-red-500 mr-3"></i>
                                Fire Department
                            </span>
                            <a href="tel:911" class="text-red-600 font-medium hover:text-red-700">911</a>
                        </div>
                        <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors">
                            <span class="text-gray-700 flex items-center">
                                <i class="fas fa-ambulance text-green-500 mr-3"></i>
                                Ambulance
                            </span>
                            <a href="tel:911" class="text-red-600 font-medium hover:text-red-700">911</a>
                        </div>
                        <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors">
                            <span class="text-gray-700 flex items-center">
                                <i class="fas fa-life-ring text-purple-500 mr-3"></i>
                                Coast Guard
                            </span>
                            <a href="tel:911" class="text-red-600 font-medium hover:text-red-700">911</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content - Map and Form -->
            <div class="xl:col-span-3">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Map and Stats -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Map Container -->
                        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden">
                            <div class="p-4 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
                                <div class="flex items-center justify-between">
                                    <h3 class="font-semibold text-gray-900 flex items-center">
                                        <i class="fas fa-map-marker-alt text-red-500 mr-2"></i>
                                        Select Incident Location
                                    </h3>
                                    <div class="flex items-center space-x-4">
                                        <div class="flex items-center space-x-2 text-sm text-gray-500">
                                            <i class="fas fa-info-circle text-blue-500"></i>
                                            <span>Click on the map to mark location</span>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button id="zoom-in" class="w-8 h-8 bg-white border border-gray-300 rounded-lg flex items-center justify-center hover:bg-gray-50">
                                                <i class="fas fa-plus text-gray-600"></i>
                                            </button>
                                            <button id="zoom-out" class="w-8 h-8 bg-white border border-gray-300 rounded-lg flex items-center justify-center hover:bg-gray-50">
                                                <i class="fas fa-minus text-gray-600"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="map" class="w-full h-96"></div>
                            <div class="p-4 bg-gray-50 border-t border-gray-100">
                                <div class="flex items-center justify-between text-sm">
                                    <div class="flex items-center space-x-4 text-gray-600">
                                        <div class="flex items-center space-x-1">
                                            <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                                            <span>Your Location</span>
                                        </div>
                                        <div class="flex items-center space-x-1">
                                            <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                            <span>Selected Location</span>
                                        </div>
                                        <div class="flex items-center space-x-1">
                                            <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                                            <span>Other Reports</span>
                                        </div>
                                    </div>
                                    <button id="use-current-location" class="text-blue-600 hover:text-blue-700 font-medium flex items-center space-x-1 bg-white px-3 py-2 rounded-lg shadow-sm">
                                        <i class="fas fa-crosshairs"></i>
                                        <span>Use Current Location</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Stats -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-white rounded-xl p-4 border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600">Reports Today</p>
                                        <p class="text-2xl font-bold text-gray-900">24</p>
                                    </div>
                                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-flag text-green-600"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-xl p-4 border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600">Active Emergencies</p>
                                        <p class="text-2xl font-bold text-gray-900">8</p>
                                    </div>
                                    <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-exclamation-triangle text-red-600"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-xl p-4 border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600">Avg. Response Time</p>
                                        <p class="text-2xl font-bold text-gray-900">12m</p>
                                    </div>
                                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-clock text-blue-600"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Report Form Sidebar -->
                    <div class="lg:col-span-1">
                        <div class="sticky top-6">
                            <!-- Form Container -->
                            <div id="report-form-container" class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden">
                                <div class="p-6 border-b border-gray-100 bg-gradient-to-r from-blue-50 to-indigo-50">
                                    <h3 class="text-xl font-semibold text-gray-900 flex items-center">
                                        <i class="fas fa-edit text-blue-600 mr-2"></i>
                                        Report Details
                                    </h3>
                                    <p class="text-sm text-gray-600 mt-1">Fill in the details about the incident</p>
                                </div>

                                <form id="report-form" class="p-6 space-y-6">
                                    <!-- Category -->
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-900 mb-3 flex items-center">
                                            <i class="fas fa-tag text-purple-600 mr-2"></i>
                                            Incident Type
                                        </label>
                                        <div class="relative">
                                            <select id="category" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all duration-200 bg-white appearance-none">
                                                <option value="fire">Fire Emergency</option>
                                                <option value="flood">Flood Situation</option>
                                                <option value="earthquake">Earthquake</option>
                                                <option value="medical">Medical Emergency</option>
                                                <option value="road_damage">Road Damage/Accident</option>
                                                <option value="infrastructure">Infrastructure Failure</option>
                                                <option value="weather">Severe Weather</option>
                                                <option value="other">Other Emergency</option>
                                            </select>
                                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                                <i class="fas fa-chevron-down"></i>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Severity -->
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-900 mb-3 flex items-center">
                                            <i class="fas fa-exclamation-circle text-orange-600 mr-2"></i>
                                            Severity Level
                                        </label>
                                        <div class="grid grid-cols-3 gap-2">
                                            <button type="button" class="severity-btn p-3 border border-gray-300 rounded-lg text-center hover:border-green-300 hover:bg-green-50 transition-colors" data-level="low">
                                                <div class="w-3 h-3 bg-green-500 rounded-full mx-auto mb-2"></div>
                                                <span class="text-xs font-medium text-gray-700">Low</span>
                                            </button>
                                            <button type="button" class="severity-btn p-3 border border-gray-300 rounded-lg text-center hover:border-yellow-300 hover:bg-yellow-50 transition-colors" data-level="medium">
                                                <div class="w-3 h-3 bg-yellow-500 rounded-full mx-auto mb-2"></div>
                                                <span class="text-xs font-medium text-gray-700">Medium</span>
                                            </button>
                                            <button type="button" class="severity-btn p-3 border border-gray-300 rounded-lg text-center hover:border-red-300 hover:bg-red-50 transition-colors" data-level="high">
                                                <div class="w-3 h-3 bg-red-500 rounded-full mx-auto mb-2"></div>
                                                <span class="text-xs font-medium text-gray-700">High</span>
                                            </button>
                                        </div>
                                        <input type="hidden" id="severity" value="medium">
                                    </div>

                                    <!-- Description -->
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-900 mb-3 flex items-center">
                                            <i class="fas fa-align-left text-green-600 mr-2"></i>
                                            Incident Description
                                        </label>
                                        <textarea 
                                            id="description" 
                                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all duration-200 resize-none bg-white" 
                                            rows="4" 
                                            placeholder="Provide detailed information about the incident, including any immediate dangers, number of people affected, and current situation..."
                                            required
                                        ></textarea>
                                        <div class="flex justify-between text-xs text-gray-500 mt-2">
                                            <span>Be specific and include relevant details</span>
                                            <span id="char-count">0/500</span>
                                        </div>
                                    </div>

                                    <!-- Image Upload -->
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-900 mb-3 flex items-center">
                                            <i class="fas fa-camera text-pink-600 mr-2"></i>
                                            Upload Evidence
                                        </label>
                                        <div id="drop-area" class="drop-area border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-gray-400 transition-colors cursor-pointer bg-gray-50">
                                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-3"></i>
                                            <p class="text-sm text-gray-600 mb-2">Drag & drop images here</p>
                                            <p class="text-xs text-gray-500 mb-4">Supports JPG, PNG, GIF ‚Ä¢ Max 5MB</p>
                                            <button type="button" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium">
                                                <i class="fas fa-folder-open mr-2"></i>
                                                Choose Files
                                            </button>
                                            <input type="file" id="image" hidden accept="image/*" multiple>
                                        </div>
                                        <div id="image-preview" class="mt-3 grid grid-cols-3 gap-2 hidden"></div>
                                    </div>

                                    <!-- Location Coordinates -->
                                    <div class="bg-gray-50 rounded-xl p-4">
                                        <label class="block text-sm font-semibold text-gray-900 mb-2 flex items-center">
                                            <i class="fas fa-map-pin text-red-600 mr-2"></i>
                                            Location Coordinates
                                        </label>
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="text-xs text-gray-600 mb-1 block">Latitude</label>
                                                <input type="text" id="latitude" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-sm" readonly>
                                            </div>
                                            <div>
                                                <label class="text-xs text-gray-600 mb-1 block">Longitude</label>
                                                <input type="text" id="longitude" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-sm" readonly>
                                            </div>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-2 flex items-center">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Select location on the map to enable submission
                                        </p>
                                    </div>

                                    <!-- Submit Button -->
                                    <button 
                                        type="submit" 
                                        id="submit-btn"
                                        disabled
                                        class="w-full py-4 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl hover:from-green-700 hover:to-green-800 transition-all duration-300 transform hover:-translate-y-0.5 shadow-lg hover:shadow-xl font-semibold flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                                    >
                                        <i class="fas fa-paper-plane mr-2"></i>
                                        Submit Emergency Report
                                    </button>

                                    <!-- Privacy Notice -->
                                    <div class="text-center">
                                        <p class="text-xs text-gray-500">
                                            <i class="fas fa-shield-alt mr-1"></i>
                                            Your report will be shared with emergency services and community responders
                                        </p>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-6 text-center max-w-sm mx-4 shadow-2xl">
        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-spinner fa-spin text-blue-600 text-2xl"></i>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Submitting Report</h3>
        <p class="text-gray-600 text-sm">Please wait while we process your emergency report...</p>
    </div>
</div>

<!-- Success Modal -->
<div id="success-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-6 text-center max-w-sm mx-4 shadow-2xl">
        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-check text-green-600 text-2xl"></i>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Report Submitted</h3>
        <p class="text-gray-600 text-sm mb-4">Your emergency report has been successfully submitted. Authorities have been notified.</p>
        <button id="success-ok" class="w-full py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
            Continue
        </button>
    </div>
</div>

<style>
    .drop-area.drag-over {
        border-color: #3b82f6;
        background-color: #eff6ff;
    }
    
    .severity-btn.active {
        border-color: #f59e0b;
        background-color: #fffbeb;
    }
    
    .severity-btn[data-level="low"].active {
        border-color: #10b981;
        background-color: #ecfdf5;
    }
    
    .severity-btn[data-level="medium"].active {
        border-color: #f59e0b;
        background-color: #fffbeb;
    }
    
    .severity-btn[data-level="high"].active {
        border-color: #ef4444;
        background-color: #fef2f2;
    }
    
    .image-preview-item {
        position: relative;
    }
    
    .image-preview-item img {
        border-radius: 8px;
    }
    
    .remove-image {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 24px;
        height: 24px;
        background: #ef4444;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .remove-image:hover {
        background: #dc2626;
        transform: scale(1.1);
    }
    
    /* Custom map styles */
    .leaflet-popup-content-wrapper {
        border-radius: 12px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    
    .leaflet-popup-tip {
        box-shadow: none;
    }
</style>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script>
    // Initialize Map with custom style
    var map = L.map('map', {
        zoomControl: false
    }).setView([0, 0], 13);
    
    // Add zoom controls
    L.control.zoom({
        position: 'topright'
    }).addTo(map);
    
    // Add custom tile layer with better styling
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        maxZoom: 19
    }).addTo(map);
    
    // Custom zoom buttons
    document.getElementById('zoom-in').addEventListener('click', function() {
        map.zoomIn();
    });
    
    document.getElementById('zoom-out').addEventListener('click', function() {
        map.zoomOut();
    });

    // Custom Marker Icons
    var userIcon = L.divIcon({
        html: '<div class="w-8 h-8 bg-blue-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><i class="fas fa-user text-white text-xs"></i></div>',
        iconSize: [32, 32],
        iconAnchor: [16, 16],
        className: 'user-location-marker'
    });

    var incidentIcon = L.divIcon({
        html: '<div class="w-10 h-10 bg-red-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><i class="fas fa-exclamation text-white text-sm"></i></div>',
        iconSize: [40, 40],
        iconAnchor: [20, 20],
        className: 'incident-location-marker'
    });

    // Get User Location
    var userMarker;
    navigator.geolocation.getCurrentPosition(function(position) {
        var lat = position.coords.latitude;
        var lon = position.coords.longitude;
        map.setView([lat, lon], 13);
        userMarker = L.marker([lat, lon], { icon: userIcon })
            .addTo(map)
            .bindPopup("<div class='text-center'><b>üìç Your Current Location</b><br>You are here</div>")
            .openPopup();
            
        // Add some sample incident markers for demonstration
        addSampleIncidents(lat, lon);
    }, function(error) {
        console.log("Geolocation error:", error);
        // Default to a reasonable location if geolocation fails
        map.setView([40.7128, -74.0060], 10); // New York
        addSampleIncidents(40.7128, -74.0060);
    });

    // Add sample incidents for demonstration
    function addSampleIncidents(lat, lon) {
        // Add a few sample incidents around the user's location
        var sampleIncidents = [
            {lat: lat + 0.01, lon: lon + 0.01, type: 'fire', description: 'Building fire reported'},
            {lat: lat - 0.008, lon: lon + 0.005, type: 'medical', description: 'Medical emergency'},
            {lat: lat + 0.005, lon: lon - 0.01, type: 'road_damage', description: 'Road accident'}
        ];
        
        sampleIncidents.forEach(function(incident) {
            var incidentMarker = L.marker([incident.lat, incident.lon], {
                icon: L.divIcon({
                    html: '<div class="w-8 h-8 bg-yellow-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><i class="fas fa-exclamation text-white text-xs"></i></div>',
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    className: 'other-incident-marker'
                })
            }).addTo(map)
            .bindPopup("<div class='text-center'><b>Reported Incident</b><br>" + incident.description + "</div>");
        });
    }

    // Click to Select Location
    var selectedMarker;
    map.on('click', function(event) {
        var lat = event.latlng.lat;
        var lon = event.latlng.lng;

        if (selectedMarker) map.removeLayer(selectedMarker);
        
        selectedMarker = L.marker([lat, lon], { icon: incidentIcon })
            .addTo(map)
            .bindPopup("<div class='text-center'><b>üìç Selected Incident Location</b><br>This is where the incident occurred</div>")
            .openPopup();
        
        document.getElementById("latitude").value = lat.toFixed(6);
        document.getElementById("longitude").value = lon.toFixed(6);
        
        // Enable submit button
        document.getElementById("submit-btn").disabled = false;
    });

    // Use Current Location Button
    document.getElementById("use-current-location").addEventListener("click", function() {
        if (userMarker) {
            var lat = userMarker.getLatLng().lat;
            var lon = userMarker.getLatLng().lng;
            
            if (selectedMarker) map.removeLayer(selectedMarker);
            
            selectedMarker = L.marker([lat, lon], { icon: incidentIcon })
                .addTo(map)
                .bindPopup("<div class='text-center'><b>üìç Selected Incident Location</b><br>Using your current location</div>")
                .openPopup();
            
            document.getElementById("latitude").value = lat.toFixed(6);
            document.getElementById("longitude").value = lon.toFixed(6);
            document.getElementById("submit-btn").disabled = false;
            
            map.setView([lat, lon], 15);
        }
    });

    // Severity Selection
    document.querySelectorAll('.severity-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.severity-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            document.getElementById('severity').value = this.dataset.level;
        });
    });

    // Initialize medium severity as active
    document.querySelector('.severity-btn[data-level="medium"]').classList.add('active');

    // Character Count
    document.getElementById('description').addEventListener('input', function() {
        document.getElementById('char-count').textContent = this.value.length + '/500';
    });

    // Image Upload Handling
    const dropArea = document.getElementById("drop-area");
    const imageInput = document.getElementById("image");
    const imagePreview = document.getElementById("image-preview");

    dropArea.addEventListener("click", () => imageInput.click());
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
        dropArea.classList.add('drag-over');
    }

    function unhighlight() {
        dropArea.classList.remove('drag-over');
    }

    dropArea.addEventListener('drop', handleDrop, false);
    imageInput.addEventListener('change', handleFiles, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles({ target: { files } });
    }

    function handleFiles(e) {
        const files = e.target.files;
        imagePreview.classList.remove('hidden');
        
        Array.from(files).forEach(file => {
            if (!file.type.match('image.*')) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const div = document.createElement('div');
                div.className = 'image-preview-item';
                div.innerHTML = `
                    <img src="${e.target.result}" class="w-full h-20 object-cover">
                    <button type="button" class="remove-image" onclick="this.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                imagePreview.appendChild(div);
            }
            reader.readAsDataURL(file);
        });
    }

    // Form Submission
    document.getElementById("report-form").addEventListener("submit", function(event) {
        event.preventDefault();

        var category = document.getElementById("category").value;
        var description = document.getElementById("description").value;
        var severity = document.getElementById("severity").value;
        var latitude = document.getElementById("latitude").value;
        var longitude = document.getElementById("longitude").value;
        var images = document.getElementById("image").files;

        if (!latitude || !longitude) {
            alert("‚ö†Ô∏è Please select a location on the map before submitting.");
            return;
        }

        var formData = new FormData();
        formData.append("category", category);
        formData.append("description", description);
        formData.append("severity", severity);
        formData.append("latitude", latitude);
        formData.append("longitude", longitude);
        
        for (let i = 0; i < images.length; i++) {
            formData.append("images", images[i]);
        }

        // Show Loading Indicator
        document.getElementById("loading").classList.remove("hidden");

        // Simulate API call
        setTimeout(() => {
            document.getElementById("loading").classList.add("hidden");
            document.getElementById("success-modal").classList.remove("hidden");
        }, 2000);
    });

    // Success modal handler
    document.getElementById("success-ok").addEventListener("click", function() {
        document.getElementById("success-modal").classList.add("hidden");
        window.location.href = "/dashboard/";
    });
</script>
{% endblock %}