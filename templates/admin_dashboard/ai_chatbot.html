{% extends 'admin_dashboard/base.html' %}

{% block title %}AI Chatbot - PublicBridge{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1><i class="fas fa-robot"></i> AI Chatbot Interface</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'ai_dashboard' %}">AI Dashboard</a></li>
                    <li class="breadcrumb-item active">AI Chatbot</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <!-- Chatbot Statistics -->
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-chart-bar"></i> Chatbot Stats</h6>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <h4 class="text-primary">{{ chatbot_stats.total_messages }}</h4>
                        <small class="text-muted">Total Messages</small>
                    </div>
                    <div class="text-center mb-3">
                        <h4 class="text-success">{{ chatbot_stats.average_confidence|floatformat:1 }}%</h4>
                        <small class="text-muted">Avg Confidence</small>
                    </div>
                    <div class="text-center mb-3">
                        <h4 class="text-warning">{{ chatbot_stats.success_rate|floatformat:1 }}%</h4>
                        <small class="text-muted">Success Rate</small>
                    </div>
                    <div class="text-center">
                        <h4 class="text-danger">{{ chatbot_stats.escalations }}</h4>
                        <small class="text-muted">Escalations</small>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="sendQuickMessage('How do I report an issue?')">
                            <i class="fas fa-plus"></i> Report Issue
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="sendQuickMessage('How do I track my report?')">
                            <i class="fas fa-search"></i> Track Report
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="sendQuickMessage('What departments are available?')">
                            <i class="fas fa-building"></i> Departments
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="sendQuickMessage('What can you help with?')">
                            <i class="fas fa-question"></i> Help
                        </button>
                    </div>
                </div>
            </div>

            <!-- Recent Conversations -->
            <div class="card">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-history"></i> Recent Chats</h6>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    {% for conversation in conversation_history %}
                    <div class="mb-2 p-2 border rounded">
                        <small class="text-muted d-block">
                            <i class="fas fa-user"></i> {{ conversation.user_message|truncatewords:5 }}
                        </small>
                        <small class="text-success d-block">
                            <i class="fas fa-robot"></i> {{ conversation.bot_response|truncatewords:5 }}
                        </small>
                        <small class="text-muted">
                            <i class="fas fa-clock"></i> {{ conversation.timestamp|date:"H:i" }}
                        </small>
                    </div>
                    {% empty %}
                    <p class="text-muted">No recent conversations.</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Chat Interface -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-comments"></i> Chat Interface</h5>
                </div>
                <div class="card-body p-0">
                    <!-- Chat Messages -->
                    <div id="chat-messages" class="p-3" style="height: 500px; overflow-y: auto; background-color: #f8f9fa;">
                        <div class="text-center text-muted mb-3">
                            <small>Welcome to PublicBridge AI Assistant! How can I help you today?</small>
                        </div>
                    </div>

                    <!-- Typing Indicator -->
                    <div id="typing-indicator" class="px-3 pb-2" style="display: none;">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm text-primary mr-2" role="status">
                                <span class="sr-only">Typing...</span>
                            </div>
                            <small class="text-muted">AI Assistant is typing...</small>
                        </div>
                    </div>

                    <!-- Chat Input -->
                    <div class="card-footer">
                        <div class="input-group">
                            <input type="text" id="message-input" class="form-control" placeholder="Type your message here..." maxlength="500">
                            <div class="input-group-append">
                                <button class="btn btn-primary" type="button" id="send-button" onclick="sendMessage()">
                                    <i class="fas fa-paper-plane"></i> Send
                                </button>
                            </div>
                        </div>
                        <small class="form-text text-muted">Press Enter to send message. Type 'human' to speak with a representative.</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Chat functionality
let conversationHistory = [];
let isProcessing = false;

function displayMessage(message, sender, confidence = null) {
    const messagesDiv = document.getElementById('chat-messages');
    const messageElement = document.createElement('div');
    messageElement.className = `mb-3 ${sender === 'user' ? 'text-right' : 'text-left'}`;
    
    const messageContent = document.createElement('div');
    messageContent.className = `d-inline-block p-3 rounded ${sender === 'user' ? 'bg-primary text-white' : 'bg-light text-dark'}`;
    messageContent.style.maxWidth = '70%';
    messageContent.innerHTML = `
        <div>${message}</div>
        ${sender === 'bot' && confidence !== null ? `<small class="text-muted d-block mt-1">Confidence: ${(confidence * 100).toFixed(1)}%</small>` : ''}
    `;
    
    messageElement.appendChild(messageContent);
    messagesDiv.appendChild(messageElement);
    
    // Scroll to bottom
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function showTypingIndicator() {
    document.getElementById('typing-indicator').style.display = 'block';
}

function hideTypingIndicator() {
    document.getElementById('typing-indicator').style.display = 'none';
}

function sendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    
    if (message === '' || isProcessing) return;
    
    // Prevent duplicate requests
    isProcessing = true;
    
    // Display user message
    displayMessage(message, 'user');
    input.value = '';
    
    // Show typing indicator
    showTypingIndicator();
    
    // Create timeout for the request (35 seconds - slightly longer than server timeout)
    const timeoutId = setTimeout(() => {
        hideTypingIndicator();
        displayMessage('Request timed out. The AI service is taking too long to respond. Please try again with a shorter message.', 'bot', 0);
        isProcessing = false;
    }, 35000);
    
    // Send to API
    fetch('{% url "chatbot_api" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => {
        clearTimeout(timeoutId);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        hideTypingIndicator();
        isProcessing = false;
        
        if (data.error) {
            displayMessage(`Sorry, I encountered an error: ${data.error}`, 'bot', 0);
            
            // Handle escalation cases
            if (data.requires_escalation) {
                displayMessage('This conversation has been escalated to a human representative. They will respond shortly.', 'bot', 1.0);
            }
        } else {
            // Use 'response' field instead of 'message' to match API format
            displayMessage(data.response, 'bot', data.confidence);
            
            // Show suggested actions if available
            if (data.suggested_actions && data.suggested_actions.length > 0) {
                const actionsText = 'Suggested actions: ' + data.suggested_actions.join(', ');
                displayMessage(actionsText, 'bot', data.confidence);
            }
            
            // Handle escalation
            if (data.requires_escalation) {
                displayMessage('This conversation has been escalated to a human representative.', 'bot', 1.0);
            }
        }
    })
    .catch(error => {
        clearTimeout(timeoutId);
        hideTypingIndicator();
        isProcessing = false;
        
        if (error.message.includes('timeout')) {
            displayMessage('The request timed out. Please try again with a shorter message.', 'bot', 0);
        } else if (error.message.includes('HTTP error')) {
            displayMessage('Sorry, the AI service is temporarily unavailable. Please try again later.', 'bot', 0);
        } else {
            displayMessage('Sorry, I encountered a network error. Please check your connection and try again.', 'bot', 0);
        }
        console.error('Error:', error);
    });
}

function sendQuickMessage(message) {
    document.getElementById('message-input').value = message;
    sendMessage();
}

// Handle Enter key
document.getElementById('message-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

// AJAX polling for stats update (preserves chat state)
function updateStats() {
    fetch('{% url "ai_dashboard" %}', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        // Update stats without reloading the page
        if (data.stats) {
            // Update total conversations
            const totalConversationsElement = document.querySelector('.card:has(.fa-comments) .h4');
            if (totalConversationsElement && data.stats.total_conversations !== undefined) {
                totalConversationsElement.textContent = data.stats.total_conversations;
            }
            
            // Update success rate
            const successRateElement = document.querySelector('.card:has(.fa-check-circle) .h4');
            if (successRateElement && data.stats.success_rate !== undefined) {
                successRateElement.textContent = data.stats.success_rate + '%';
            }
            
            // Update active users
            const activeUsersElement = document.querySelector('.card:has(.fa-users) .h4');
            if (activeUsersElement && data.stats.active_users !== undefined) {
                activeUsersElement.textContent = data.stats.active_users;
            }
        }
    })
    .catch(error => {
        console.error('Error updating stats:', error);
    });
}

// Poll stats every 30 seconds
setInterval(updateStats, 30000);
</script>

<style>
#chat-messages {
    background-image: linear-gradient(45deg, #f8f9fa 25%, transparent 25%), 
                      linear-gradient(-45deg, #f8f9fa 25%, transparent 25%), 
                      linear-gradient(45deg, transparent 75%, #f8f9fa 75%), 
                      linear-gradient(-45deg, transparent 75%, #f8f9fa 75%);
    background-size: 20px 20px;
    background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
}

.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    border: none;
}

.bg-light {
    background-color: #f8f9fa !important;
}

.list-group-item {
    border-left: 3px solid #007bff;
}

.btn-outline-primary {
    border-color: #007bff;
    color: #007bff;
}

.btn-outline-primary:hover {
    background-color: #007bff;
    color: white;
}
</style>
{% endblock %}